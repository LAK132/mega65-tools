pipeline {
    agent {
        docker { image 'megawin' }
    }
    stages {
        stage('Cleanup') {
            steps {
                sh 'make USE_LOCAL_CC65=1 cleanall'
            }
        }
        stage ('Full PR Testbuild') {
            when {
                branch pattern: "PR-*"
            }
            steps {
                sh 'make USE_LOCAL_CC65=1 all'
            }
        }
        stage('Build Linux Tools') {
            when {
                not { branch pattern: "PR-*" }
            }
            steps {
                sh 'make USE_LOCAL_CC65=1 arcunix'
            }
        }
        stage('Build Windows Tools') {
            when {
                not { branch pattern: "PR-*" }
            }
            steps {
                sh 'make USE_LOCAL_CC65=1 arcwin'
            }
        }
        stage('Run build tests') {
            steps {
                sh 'make USE_LOCAL_CC65=1 test'
            }
        }
    }
    post {
        always {
            script {
                if (!env.BRANCH_NAME.startsWith('PR-')) {
                    archiveArtifacts artifacts: "m65tools-*.7z",
                        onlyIfSuccessful: true,
                        fingerprint: true
                }
            }
        }
    }
}
