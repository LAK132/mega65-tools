pipeline {
    agent {
        docker { image 'megawin' }
    }
    environment {
        USE_LOCAL_CC65 = 1
        WIN_CROSS_BUILD = 1
    }
    stages {
        stage('Cleanup') {
            steps {
                sh 'make cleanall'
            }
        }
        stage ('Full PR Testbuild') {
            when {
                branch pattern: "PR-*"
            }
            steps {
                sh 'make all'
            }
        }
        stage('Build Linux Tools') {
            when {
                not { branch pattern: "PR-*" }
            }
            steps {
                sh 'make arcunix'
            }
        }
        stage('Build Windows Tools') {
            when {
                not { branch pattern: "PR-*" }
            }
            steps {
                sh 'make arcwin'
            }
        }
        stage('Run build tests') {
            steps {
                sh 'make test'
            }
        }
    }
    post {
        always {
            script {
                if (!env.BRANCH_NAME.startsWith('PR-')) {
                    archiveArtifacts artifacts: "m65tools-*.7z",
                        onlyIfSuccessful: true,
                        fingerprint: true
                }
            }
        }
    }
}
